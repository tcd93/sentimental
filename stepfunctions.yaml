AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Step Functions for Sentiment Analysis

Parameters:
  RedditScraperName:
    Type: String
    Description: Name of the Reddit scraper Lambda function
  SteamScraperName:
    Type: String
    Description: Name of the Steam scraper Lambda function
  SentimentJobCreatorName:
    Type: String
    Description: Name of the sentiment job creator Lambda function
  GetJobStatusName:
    Type: String
    Description: Name of the job status checker Lambda function
  SyncPostToSupabaseName:
    Type: String
    Description: Name of the sync post to Supabase Lambda function
  BucketName:
    Type: String
    Description: Name of the S3 bucket for storing posts
  ErrorTopicName:
    Type: String
    Description: Name of the SNS topic for error notifications
  ErrorTopicArn:
    Type: String
    Description: ARN of the SNS topic for error notifications

Resources:
  KeywordPipelineLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vendedlogs/states/KeywordPipeline
      RetentionInDays: 7
      
  JobProcessorLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /aws/vendedlogs/states/JobProcessorPipeline
      RetentionInDays: 7

  # First pipeline - handles scraping and job creation
  KeywordPipeline:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: STANDARD
      Logging:
        Level: ALL
        IncludeExecutionData: true
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt KeywordPipelineLogGroup.Arn
      Policies:
        - CloudWatchLogsFullAccess
        - LambdaInvokePolicy:
            FunctionName: !Ref RedditScraperName
        - LambdaInvokePolicy:
            FunctionName: !Ref SteamScraperName
        - LambdaInvokePolicy:
            FunctionName: !Ref SentimentJobCreatorName
        - S3CrudPolicy:
            BucketName: !Ref BucketName
        - SNSPublishMessagePolicy:
            TopicName: !Ref ErrorTopicName
        - AWSStepFunctionsFullAccess
      Definition:
        StartAt: GetConfiguration
        States:
          GetConfiguration:
            Type: Task
            Resource: "arn:aws:states:::aws-sdk:s3:getObject"
            Parameters:
              Bucket: !Ref BucketName
              Key: "config/keywords_config.json"
            ResultSelector:
              Json.$: "States.StringToJson($.Body)"
            OutputPath: "$.Json"
            Next: SelectScrapers
          SelectScrapers:
            Type: Parallel
            Branches:
              - StartAt: ProcessRedditTasks
                States:
                  ProcessRedditTasks:
                    Type: Map
                    InputPath: $.source.reddit
                    MaxConcurrency: 40
                    ToleratedFailurePercentage: 80
                    Iterator:
                      ProcessorConfig:
                        Mode: DISTRIBUTED
                        ExecutionType: EXPRESS
                      StartAt: RedditScraper
                      States:
                        RedditScraper:
                          Type: Task
                          Resource: "arn:aws:states:::lambda:invoke"
                          Parameters:
                            FunctionName: !Ref RedditScraperName
                            Payload.$: "$"
                          OutputPath: "$.Payload"
                          Next: StoreRedditPosts
                        StoreRedditPosts:
                          Type: Map
                          ItemsPath: $.posts
                          ItemSelector:
                            Key.$: States.Format('posts/{}.json', $$.Map.Item.Value.id)
                            Body.$: $$.Map.Item.Value
                          # Returns only the id of the post to avoid payload size limit of Step Functions
                          OutputPath: $.posts[*].id
                          MaxConcurrency: 40
                          Iterator:
                            StartAt: StoreRedditPostToS3
                            States:
                              StoreRedditPostToS3:
                                Type: Task
                                Resource: "arn:aws:states:::aws-sdk:s3:putObject"
                                Parameters:
                                  Bucket: !Ref BucketName
                                  Key.$: $.Key
                                  Body.$: $.Body
                                  ContentType: application/json
                                End: true
                          ResultPath: $.stored_posts
                          End: true
                    End: true
                    OutputPath: $[*][*]
                    Retry:
                      - ErrorEquals:
                          - States.TaskFailed
                          - States.Timeout
                        BackoffRate: 2
                        IntervalSeconds: 20
                        MaxAttempts: 3
                        JitterStrategy: FULL
                    Catch:
                      - ErrorEquals:
                          - States.TaskFailed
                          - States.Timeout
                        Next: SNSPublishRedditError
                        ResultPath: $.error
                  SNSPublishRedditError:
                    Type: Task
                    Resource: "arn:aws:states:::sns:publish"
                    Parameters:
                      TopicArn: !Ref ErrorTopicArn
                      "Message.$": "$"
                    End: true
              - StartAt: ProcessSteamTasks
                States:
                  ProcessSteamTasks:
                    Type: Map
                    InputPath: $.source.steam
                    ToleratedFailurePercentage: 80
                    MaxConcurrency: 40
                    Iterator:
                      ProcessorConfig:
                        Mode: DISTRIBUTED
                        ExecutionType: EXPRESS
                      StartAt: SteamScraper
                      States:
                        SteamScraper:
                          Type: Task
                          Resource: "arn:aws:states:::lambda:invoke"
                          Parameters:
                            FunctionName: !Ref SteamScraperName
                            Payload.$: "$"
                          OutputPath: "$.Payload"
                          Next: StoreSteamPosts
                        StoreSteamPosts:
                          Type: Map
                          ItemsPath: "$.posts"
                          ItemSelector:
                            Key.$: States.Format('posts/{}.json', $$.Map.Item.Value.id)
                            Body.$: $$.Map.Item.Value
                          # Returns only the id of the post to avoid payload size limit of Step Functions
                          OutputPath: $.posts[*].id
                          MaxConcurrency: 40
                          Iterator:
                            StartAt: StoreSteamPostToS3
                            States:
                              StoreSteamPostToS3:
                                Type: Task
                                Resource: "arn:aws:states:::aws-sdk:s3:putObject"
                                Parameters:
                                  Bucket: !Ref BucketName
                                  Key.$: $.Key
                                  Body.$: $.Body
                                  ContentType: application/json
                                End: true
                          ResultPath: "$.stored_posts"
                          End: true
                    End: true
                    OutputPath: $[*][*]
                    Retry:
                      - ErrorEquals:
                          - States.TaskFailed
                          - States.Timeout
                        BackoffRate: 2
                        IntervalSeconds: 20
                        MaxAttempts: 3
                        JitterStrategy: FULL
                    Catch:
                      - ErrorEquals:
                          - States.TaskFailed
                          - States.Timeout
                        Next: SNSPublishSteamError
                        ResultPath: $.error
                  SNSPublishSteamError:
                    Type: Task
                    Resource: "arn:aws:states:::sns:publish"
                    Parameters:
                      TopicArn: !Ref ErrorTopicArn
                      "Message.$": "$"
                    End: true
            OutputPath: $[*][*]
            Next: CreateSentimentJob
          CreateSentimentJob:
            Type: Task
            OutputPath: $.Payload
            Resource: "arn:aws:states:::lambda:invoke"
            Parameters:
              FunctionName: !Ref SentimentJobCreatorName
              Payload.$: $
            Next: StartJobProcessor
          StartJobProcessor:
            Type: Task
            Resource: "arn:aws:states:::states:startExecution"
            Parameters:
              StateMachineArn: !Ref JobProcessorPipeline
              Input.$: "$"
            End: true
            
      # Add the Events section directly to the StateMachine
      Events:
        HourlyTrigger:
          Type: Schedule
          Properties:
            Schedule: rate(1 hour)
            Input: "{}"  # Empty input, since we're loading from S3

  # Second pipeline - handles job processing
  JobProcessorPipeline:
    Type: AWS::Serverless::StateMachine
    Properties:
      Type: STANDARD
      Logging:
        Level: ALL
        IncludeExecutionData: true
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt JobProcessorLogGroup.Arn
      Policies:
        - CloudWatchLogsFullAccess
        - LambdaInvokePolicy:
            FunctionName: !Ref GetJobStatusName
        - LambdaInvokePolicy:
            FunctionName: !Ref SyncPostToSupabaseName
        - S3CrudPolicy:
            BucketName: !Ref BucketName
        - SNSPublishMessagePolicy:
            TopicName: !Ref ErrorTopicName
        - AWSStepFunctionsFullAccess
      Definition:
        StartAt: GetJobStatus
        States:
          GetJobStatus:
            Type: Task
            Resource: "arn:aws:states:::lambda:invoke"
            Parameters:
              FunctionName: !Ref GetJobStatusName
              Payload.$: "$"
            OutputPath: "$.Payload"
            Next: JobComplete
          JobComplete:
            Type: Choice
            Choices:
              - Variable: "$.status"
                StringEquals: "COMPLETED"
                Next: MapPosts
              - Variable: "$.status"
                StringEquals: "FAILED"
                Next: FailJob
            Default: Wait75Seconds
          Wait75Seconds:
            Type: Wait
            Seconds: 75
            Next: GetJobStatus
          FailJob:
            Type: Fail
            Error: "Job failed, check logs for more details"
          MapPosts:
            Type: Map
            Comment: Map posts that are stored in S3
            OutputPath: "$[*][*]"
            ItemProcessor:
              ProcessorConfig:
                Mode: DISTRIBUTED
                ExecutionType: EXPRESS
              StartAt: SyncPostToSupabase
              States:
                SyncPostToSupabase:
                  Type: Task
                  Resource: "arn:aws:states:::lambda:invoke"
                  Parameters:
                    FunctionName: !Ref SyncPostToSupabaseName
                    Payload.$: "$"
                  OutputPath: "$.Payload"
                  End: true
            Label: Map
            MaxConcurrency: 1000
            ItemBatcher:
              MaxItemsPerBatch: 5
              BatchInput:
                Job.$: "$"
            ItemReader:
              Resource: "arn:aws:states:::s3:listObjectsV2"
              Parameters:
                Bucket: !Ref BucketName
                Prefix: "posts/"
            Next: DeletePosts
          DeletePosts:
            Type: Task
            Parameters:
              Bucket: !Ref BucketName
              Delete:
                Objects.$: "$"
            Resource: "arn:aws:states:::aws-sdk:s3:deleteObjects"
            End: true

Outputs:
  KeywordPipelineArn:
    Description: Step Functions ARN for the keyword pipeline
    Value: !Ref KeywordPipeline
  JobProcessorPipelineArn:
    Description: Step Functions ARN for the job processor pipeline
    Value: !Ref JobProcessorPipeline